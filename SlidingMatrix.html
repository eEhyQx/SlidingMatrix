<!DOCTYPE html>
<html>
<head>
    <title>Sliding Matrix</title>
    <style>
        canvas{
            display: block;
            margin: 0 auto;
            border-radius: 10px;
            background-color: #0E8F81;
        }
    </style>
</head>
<body bgcolor="#034D45">
    <center id="notification" style="font:bold 20px Arial,Microsoft Yahei;color:#FFFFFF" ></center><br/>
    <center id="title" style="font:bold 70px Arial,Microsoft Yahei;color:#FFFFFF"></center><br/>
    <center id="steps" style="font:bold 25px Arial,Microsoft Yahei;color:#FFFFFF"></center><br/>
    <canvas id="canvas" width="500" height="500"></canvas>
    
    <script>
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext('2d');
        var map_degree=4;
        var map;
        var offsetx = {1:53,2:34,3:28,4:25};
        var keycom = {'87':[-1,0],'83':[1,0],'65':[0,-1],'68':[0,1],'74':[0,0,0],'75':[0,0,1],'76':"reverse",'79':"go_back"}; 
        //up,down,left,right,j,k,l
        //add row and colomn move
        var row_move=0;
        var col_move=0;
        var reverse=false;
        
        var default_color="#8AD9D0";
        var core_color="#FFFFFF";
        var default_num_size={1:60,2:60,3:50,4:40};
        var stepcount=0;
        var core_position=[0,0];
        var step_documents=new Array();
        step_documents[0]=['num','row_or_col','times'];

        //add function get_map_degree
        function get_map_degree(){
            map_degree=prompt("Please choose the degree of the matrix:(positive integer)","4"); 
            return map_degree;           
        }
        
        
        function createmap(degree){
            var map=new Array();
            for(var i=0;i<degree;i++){
                map[i]=new Array();
                for(var j=0;j<degree;j++){
                    map[i][j]=1+i*degree+j;
                }
            }
            return map;
        }

        function draw(){
            formap(function(i,j){
                    var num = map[i][j];
                    if (i==core_position[0] && j==core_position[1]){
                        ctx.fillStyle=core_color;
                    }
                    else{
                        ctx.fillStyle=default_color;
                    }
                    ctx.fillRect(j*120+20,i*120+20,100,100);
                    ctx.font = "bold "+default_num_size[String(num).length]+"px Arial,Microsoft Yahei";
                    ctx.fillStyle = "#266059";
                    ctx.fillText(String(num),j*120+offsetx[String(num).length],i*120+70+default_num_size[String(num).length]/3);
                    console.log('step_documents: '+String(step_documents));
                });
            document.getElementById("steps").style="font:bold "+String(parseInt(25*map_degree/4))+"px Arial,Microsoft Yahei;color:#FFFFFF"
            document.getElementById("steps").innerText="steps: "+String(step_documents.length-1);
        }

        function formap(func){
            for(var i=0;i<map_degree;i++)
                for(var j=0;j<map_degree;j++){
                    func(i,j);
                }
        }
     
        function move(x,direction,reverse_on=reverse,record_on=true){
            var step=[x,direction];
            if(reverse_on==true){
                if(step[0]==step_documents[step_documents.length-1][0] && step[1]==step_documents[step_documents.length-1][1] && record_on==true){
                    step_documents[step_documents.length-1][2]=(step_documents[step_documents.length-1][2]-1+map_degree)%map_degree;
                }
                else if(record_on==true){
                    step_documents[step_documents.length]=[x,direction,map_degree-1];
                }
                if(direction){
                    var tmp=map[0][x];
                    for(i=0;i<map_degree-1;i++){
                        map[i][x]=map[i+1][x];
                    }
                    map[map_degree-1][x]=tmp;
                }
                else{
                    var tmp=map[x][0];
                    for(i=0;i<map_degree-1;i++){
                        map[x][i]=map[x][i+1];
                    }
                    map[x][map_degree-1]=tmp;
                }
            }
            else{
                if(step[0]==step_documents[step_documents.length-1][0] && step[1]==step_documents[step_documents.length-1][1] && record_on==true){
                    step_documents[step_documents.length-1][2]=(step_documents[step_documents.length-1][2]+1)%map_degree;
                }
                else if(record_on==true){
                    step_documents[step_documents.length]=[x,direction,1];
                }
                if(direction){
                    var tmp=map[map_degree-1][x];
                    for(i=0;i<map_degree-1;i++){
                        map[map_degree-i-1][x]=map[map_degree-i-2][x];
                    }
                    map[0][x]=tmp;
                }
                else{
                    var tmp=map[x][map_degree-1];
                    for(i=0;i<map_degree-1;i++){
                        map[x][map_degree-i-1]=map[x][map_degree-i-2];
                    }
                    map[x][0]=tmp;
                }
            }
            return null;
        }
        //j(true) means row-move and k(false) means colomn-move
        
                       
        /* ;*/
        function core_location(input){
            if(input in keycom){
                if(keycom[input].length==2){
                    core_position[0]+=keycom[input][0];
                    core_position[0]=(core_position[0]+map_degree)%map_degree;
                    core_position[1]+=keycom[input][1];
                    core_position[1]=(core_position[1]+map_degree)%map_degree;
                }
                else if(keycom[input]=="reverse"){
                   tmp=core_color;
                   core_color=default_color;
                   default_color=tmp;
                   reverse= !reverse;
                   console.log(String(reverse))
                   return null;
                }
                else if(keycom[input]=="go_back"){
                   tmp=step_documents[step_documents.length-1];
                   var i=0;
                   while(i<tmp[2]){
                       move(tmp[0],tmp[1],true,false);
                       i++;
                   }
                   if(step_documents.length>1){
                       step_documents.pop();
                   }
                   return null;
                }
                else{
                    command=keycom[input][2];
                    return command;
                }
            }
            else return null;
        } 
        

        function is_neat(){
            ans=true;
            for (var i=0;i<map_degree;i++){
                for (var j=0;j<map_degree;j++){
                    if ((i*map_degree+j)!=map[i][j]){
                        ans=false;
                        break;
                    }   
                }
                if (ans==false) break;
            };
            return ans;
        }
        /*def judge(*state):
    l=len(state)
    n=l**0.5
    s=1
    if n!=int(n):
        print "not a square!"
        return
    if set(state)!=set(range(0,l)):
        print "data error!"
        return
    if n%2==0:
        print True
        return
    for i in range(0,l):
        for j in range(0,l):
            if i>j:
                s*=(state[i]-state[j])
    print s>0
*/
        //try to prove the existence of solution
        function has_solution(){
            ans=true;
            return ans;            
        }

        
        var sx,sy,dx,dy,ex,ey;
        canvas.ontouchstart=function(event){
            
        }
        canvas.ontouchmove=function(event){
        }
        canvas.ontouchend=function(event){
        }

        document.getElementById("title").innerText="Sliding Matrix";
        map_degree=Number(get_map_degree());
        document.getElementById("title").style="font:bold "+String(parseInt(75*map_degree/4))+"px Arial,Microsoft Yahei;color:#FFFFFF"
        alert ("map_degree="+String(map_degree));  
        canvas.width=20+120*map_degree;
        canvas.height=20+120*map_degree;
        map=createmap(map_degree);
        draw(); 

        document.onkeydown=function(e){
            dir =(e?e:event).keyCode;
            console.log(dir);
            cmd=core_location(dir);
            if (cmd!=null){

                move(core_position[cmd],cmd);
            }
            draw();
        };       

    </script>
</body>
</html>
        