<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Sliding Matrix</title>
    <style>
        canvas{
            display: block;
            margin: 0 auto;
            border-radius: 10px;
            background-color: #0E8F81;
        }
        button {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.004);
        }
    </style>
    <link rel="stylesheet" type="text/css" media="screen" href="./css/mui.css" />
    <script src="./js/mui.js"></script>
</head>
<body style="background-color: #034D45;">
        <center id="notification_1" style="font:bold 20px Arial,Microsoft Yahei;color:#FFFFFF" ></center><br/>
        <center id="notification_2" style="font:bold 20px Arial,Microsoft Yahei;color:#FFFFFF" ></center><br/>
        <center id="title" style="font:bold 70px Arial,Microsoft Yahei;color:#FFFFFF;">Sliding Matrix</center><br/>
        <center id="steps" style="font:regular 25px Arial,Microsoft Yahei;color:#FFFFFF">steps:</center><br/>
        <canvas id="canvas" width="10" height="10"></canvas>
        <center id="notification_3" style="font:bold 20px Arial,Microsoft Yahei;color:#FFFFFF" ></center><br/>
        <center id="notification_4" style="font:bold 20px Arial,Microsoft Yahei;color:#FFFFFF" ></center><br/>
        <center><button id="more" class="mui-btn mui-btn--fab" style="background-color:#0E8F81;font:bold 20px Microsoft Yahei,Arial;color:#034D45">···</button></center>
        <center id="notification_5" style="font:bold 20px Arial,Microsoft Yahei;color:#FFFFFF" ></center><br/>
    <script>
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext('2d');
        var map_degree=4;
        var map;
        var offsetx = {1:53,2:34,3:28,4:25};
        var keycom = {'87':[-1,0],'83':[1,0],'65':[0,-1],'68':[0,1],'74':[0,true,0],'75':[0,false,1],'76':[0,false,0],'73':[0,true,1],'79':"go_back"}; 
        //up,down,left,right,j,k,l
        //add row and colomn move
        var row_move=0;
        var col_move=0;
        
        var default_color="#8AD9D0";
        var core_color="#FFFFFF";
        var default_num_size={1:60,2:60,3:50,4:40};
        var stepcount=0;
        var core_position=[0,0];
        var step_documents=new Array();
        step_documents[0]=['num','row_or_col','times'];
        var screen_Width=window.screen.width;
        var screen_Height=window.screen.height;

        //add function get_map_degree
        function get_map_degree(){
            map_degree=prompt("Please choose the degree of the matrix:(positive integer)","4"); 
            return map_degree;           
        }

        function px_scale(px_num){
            if(screen_Height>500 && screen_Width>500 && screen_Height>=screen_Width){
                return parseInt(px_num/map_degree/800*screen_Width*4);
            }
            if(screen_Height>500 && screen_Width>500 && screen_Width>screen_Height){
                return parseInt(px_num/map_degree/1024*screen_Height*4);
            }
            if(screen_Height<=500 || screen_Width<=500 && screen_Width>=screen_Height){
                return parseInt(px_num/map_degree/1024*screen_Height*4);
            }
            if(screen_Height<=500 || screen_Width<=500 && screen_Height>screen_Width){
                return parseInt(px_num/map_degree/300*screen_Width*4);
            }
        }
        
        
        function createmap(degree){
            var map=new Array();
            for(var i=0;i<degree;i++){
                map[i]=new Array();
                for(var j=0;j<degree;j++){
                    map[i][j]=1+i*degree+j;
                }
            }
            return map;
        }

        function draw(){
            formap(function(i,j){
                    var num = map[i][j];
                    if (i==core_position[0] && j==core_position[1]){
                        ctx.fillStyle=core_color;
                    }
                    else{
                        ctx.fillStyle=default_color;
                    }
                    ctx.fillRect(j*px_scale(120)+px_scale(20),i*px_scale(120)+px_scale(20),px_scale(100),px_scale(100));
                    ctx.font = "bold "+px_scale(default_num_size[String(num).length])+"px Arial,Microsoft Yahei";
                    ctx.fillStyle = "#266059";
                    ctx.fillText(String(num),j*px_scale(120)+px_scale(offsetx[String(num).length]),i*px_scale(120)+px_scale(70)+px_scale(default_num_size[String(num).length]/3));
                    console.log('step_documents: '+String(step_documents));
                });
            document.getElementById("steps").style="font: "+String(parseInt(canvas.width/15))+"px Arial,Microsoft Yahei;color:#FFFFFF"
            document.getElementById("steps").innerText="Steps: "+String(step_documents.length-1);
        }

        function formap(func){
            for(var i=0;i<map_degree;i++)
                for(var j=0;j<map_degree;j++){
                    func(i,j);
                }
        }
     
        function move(x,direction,reverse_on=false,record_on=true){
            var step=[x,direction];
            if(reverse_on==true){
                if(step[0]==step_documents[step_documents.length-1][0] && step[1]==step_documents[step_documents.length-1][1] && record_on==true){
                    step_documents[step_documents.length-1][2]=(step_documents[step_documents.length-1][2]-1+map_degree)%map_degree;
                }
                else if(record_on==true){
                    step_documents[step_documents.length]=[x,direction,map_degree-1];
                }
                if(direction){
                    var tmp=map[0][x];
                    for(i=0;i<map_degree-1;i++){
                        map[i][x]=map[i+1][x];
                    }
                    map[map_degree-1][x]=tmp;
                    if(record_on==true){
                        core_position[0]=(core_position[0]-1+map_degree)%map_degree;
                    }
                }
                else{
                    var tmp=map[x][0];
                    for(i=0;i<map_degree-1;i++){
                        map[x][i]=map[x][i+1];
                    }
                    map[x][map_degree-1]=tmp;
                    if(record_on==true){
                        core_position[1]=(core_position[1]-1+map_degree)%map_degree;
                    }
                }
            }
            else{
                if(step[0]==step_documents[step_documents.length-1][0] && step[1]==step_documents[step_documents.length-1][1] && record_on==true){
                    step_documents[step_documents.length-1][2]=(step_documents[step_documents.length-1][2]+1)%map_degree;
                }
                else if(record_on==true){
                    step_documents[step_documents.length]=[x,direction,1];
                }
                if(direction){
                    var tmp=map[map_degree-1][x];
                    for(i=0;i<map_degree-1;i++){
                        map[map_degree-i-1][x]=map[map_degree-i-2][x];
                    }
                    map[0][x]=tmp;
                    if(record_on==true){
                        core_position[0]=(core_position[0]+1)%map_degree;
                    }
                }
                else{
                    var tmp=map[x][map_degree-1];
                    for(i=0;i<map_degree-1;i++){
                        map[x][map_degree-i-1]=map[x][map_degree-i-2];
                    }
                    map[x][0]=tmp;
                    if(record_on==true){
                        core_position[1]=(core_position[1]+1)%map_degree;
                    }
                }
            }
            return null;
        }
        //j(true) means row-move and k(false) means colomn-move

        function core_location(input){
            if(input in keycom){
                if(keycom[input].length==2){
                    core_position[0]+=keycom[input][0];
                    core_position[0]=(core_position[0]+map_degree)%map_degree;
                    core_position[1]+=keycom[input][1];
                    core_position[1]=(core_position[1]+map_degree)%map_degree;
                }
                else if(keycom[input]=="go_back"){
                   tmp=core_color;
                   core_color=default_color;
                   default_color=tmp;
                   tmp=step_documents[step_documents.length-1];
                   var i=0;
                   while(i<tmp[2]){
                       move(tmp[0],tmp[1],true,false);
                       i++;
                   }
                   if(step_documents.length>1){
                       step_documents.pop();
                   }
                   setTimeout("tmp=core_color;core_color=default_color;default_color=tmp;draw();","100");
                   return null;
                }
                else if(keycom[input].length==3){
                    command=[keycom[input][2],keycom[input][1]];
                    return command;
                }
            }
            else{
                return null;
            }
        } 
        
        function is_neat(){
            ans=true;
            for (var i=0;i<map_degree;i++){
                for (var j=0;j<map_degree;j++){
                    if ((i*map_degree+j)!=map[i][j]){
                        ans=false;
                        break;
                    }   
                }
                if (ans==false) break;
            };
            return ans;
        }

        function has_solution(state){
            if(map_degree%2==0){
                return true;
            }
            var s=1;
            var state_p=state.reduce(function (a, b) { return a.concat(b)} );
            var len=map_degree*map_degree;
            for(m=0;m<len;m++){
                for(n=0;n<len;n++){
                    if(m>n){
                        s*=(state_p[m]-state_p[n]);
                    }
                }
            }
            return s>0;            
        }

        var sx,sy,dx,dy,ex,ey;
        canvas.ontouchstart=function(event){
            
        }
        canvas.ontouchmove=function(event){
        }
        canvas.ontouchend=function(event){
        }

        map_degree=Number(get_map_degree());
        alert ("map_degree="+String(map_degree));
        canvas.width=px_scale(20)+px_scale(120)*map_degree;
        canvas.height=px_scale(20)+px_scale(120)*map_degree;
        canvas.style="display: block;margin: 0 auto;border-radius: "+px_scale(10)+"px;background-color: #0E8F81;"
        document.getElementById("more").style="background-color:#0E8F81;height:"+String(parseInt(canvas.width/7))+"px;width:"+String(parseInt(canvas.width/7))+"px;font:bold 20px Microsoft Yahei,Arial;color:#034D45";
        document.getElementById("title").style="font:bold "+String(parseInt(canvas.width/6.5))+"px Arial,Microsoft Yahei;color:#FFFFFF;"
        map=createmap(map_degree);
        draw(); 

        document.onkeydown=function(e){
            dir =(e?e:event).keyCode;
            cmd=core_location(dir);
            if (cmd!=null){
                move(core_position[cmd[0]],cmd[0],cmd[1]);
            }
            draw();
        };
    </script>
</body>
</html>
        